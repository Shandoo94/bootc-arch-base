name: Bump Base Digest

on:
  schedule:
    - cron: "0 6 * * 1" # Mondays 06:00 UTC (adjust)
  workflow_dispatch:

concurrency:
  group: bump-base-digest
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  bump:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install skopeo + jq
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo jq

      - name: Resolve newest base-* and digest
        id: resolve
        run: |
          set -euo pipefail

          REPO="docker.io/library/archlinux"

          latest_tag="$(skopeo list-tags docker://$REPO \
            | jq -r '.Tags[]' \
            | grep '^base-[0-9]' \
            | sort -V \
            | tail -1)"

          if [ -z "$latest_tag" ]; then
            echo "No base-* tags found for $REPO" >&2
            exit 1
          fi

          digest="$(skopeo inspect --format '{{.Digest}}' docker://$REPO:$latest_tag)"
          media="$(skopeo inspect --format '{{.MediaType}}' docker://$REPO:$latest_tag)"

          # Sanity: ensure digest is actually retrievable
          skopeo inspect "docker://$REPO@$digest" >/dev/null

          echo "latest_tag=$latest_tag" >> "$GITHUB_OUTPUT"
          echo "digest=$digest" >> "$GITHUB_OUTPUT"
          echo "mediaType=$media" >> "$GITHUB_OUTPUT"
          echo "new_ref=$REPO@$digest" >> "$GITHUB_OUTPUT"

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Verify signature
        run: cosign verify "${{ steps.resolve.outputs.new_ref }}" --certificate-identity-regexp="https://gitlab\.archlinux\.org/archlinux/archlinux-docker//\.gitlab-ci\.yml@refs/tags/v[0-9]+\.0\.[0-9]+" --certificate-oidc-issuer=https://gitlab.archlinux

      - name: Update lockfile (only if changed)
        run: |
          new="${{ steps.resolve.outputs.new_ref }}"
          old="$(cat base-image.lock 2>/dev/null || true)"

          if [ "$new" = "$old" ]; then
            echo "base-image.lock already up to date: $new"
            exit 0
          fi

          echo "$new" > base-image.lock

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(deps): bump arch base to ${{ steps.resolve.outputs.latest_tag }}"
          title: "chore(deps): bump arch base to ${{ steps.resolve.outputs.latest_tag }}"
          body: |
            Updates pinned Arch base image:
            - Tag: `${{ steps.resolve.outputs.latest_tag }}`
            - Digest: `${{ steps.resolve.outputs.digest }}`
          branch: chore/bump-base-image-version
          delete-branch: true
          force: false
